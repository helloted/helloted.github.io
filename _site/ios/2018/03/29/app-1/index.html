<!DOCTYPE html>
<html lang="en">

<head>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-4165845420824687",
    enable_page_level_ads: true
  });
</script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Write your site description here. It will be used as your sites meta description as well!">

    <title>APP生成与运行(一) - Helloted Blog</title>

    <link rel="canonical" href="http://www.helloted.com/ios/2018/03/29/app-1/">

    <link rel="shortcut icon" href="/img/favicon.ico">
   
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->


    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/prism.css">

    <!-- Custom Fonts -->
<!--     <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'> -->

     <link rel="stylesheet" href="/css/clean-blog.css">

     <link rel="stylesheet" href="/css/custom.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Helloted Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
				
                <li>
                    <a href="/aacategory/">Categorys</a>
                </li>
				
                
				
                <li>
                    <a href="/aarchive/">Archive</a>
                </li>
				
                
				
                <li>
                    <a href="/about/">About</a>
                </li>
				
                
				
                <li>
                    <a href="/app/">APP</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/bg_01.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>APP生成与运行(一)</h1>
                    
                    <h2 class="subheading">APP编译过程</h2>
                    
                    <span class="meta">Posted by Ted on March 29, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h3 id="一编译">一、编译</h3>

<h4 id="汇编">汇编</h4>

<p>CPU 由上亿个晶体管组成，在运行的时候，单个晶体管只能根据电流的流通或关闭来确认两种状态，我们一般说 0 或 1，根据这种状态，人类创造了二进制，通过二进制编码我们可以表示所有的概念。但是，CPU 依然只能执行二进制代码。我们将一组二进制代码合并成一个指令或符号，创造了汇编语言，汇编语言以一种相对好理解的方式来编写，然后通过汇编过程生成 CPU 可以运行的二进制代码并运行在 CPU 上。</p>

<h4 id="编译">编译</h4>

<p>编译器将原始程序（Source program）作为输入，翻译产生使用目标语言（Target language）的等价程序。源代码一般为高阶语言 (High-level language), 如C、C++、C# 、Objective-C、Swift、Java 等，而目标语言则是汇编语言或目标机器的目标代码（Object code），有时也称作机器代码（Machine code）</p>

<h4 id="编译型语言和解释型语言">编译型语言和解释型语言</h4>

<p>编译程序是整体编译完了，再一次性执行。 而解释程序是一边解释，一边执行。</p>

<p>编译型语言：C系，java</p>

<p>解释型语言：html、javascript</p>

<h3 id="二llvmclang">二、LLVM、Clang</h3>

<h4 id="llvm">LLVM</h4>

<p>LLVM本身并不是编译器，只是一套用于开发编译器、解释器等程序语言相关工具的库，主要聚焦于编译器后端功能，如代码生成、代码优化、JIT等。</p>

<blockquote>
  <p>LLVM<a href="http://www.aosabook.org/en/llvm.html#footnote-1">1</a> an umbrella project that hosts and develops a set of close-knit low-level toolchain components (e.g., assemblers, compilers, debuggers, etc.)</p>

  <p>LLVM 是一个涵盖和开发一系列紧密结合的低级工具链组件（例如，汇编器，编译器，调试器等）的综合项目</p>
</blockquote>

<p>传统的编译器通常分为三个部分，前端(frontEnd)，优化器(Optimizer)和后端(backEnd)，在编译过程中，前端主要负责词法和语法分析，将源代码转化为抽象语法树；优化器则是在前端的基础上，对得到的中间代码进行优化，使代码更加高效；后端则是将已经优化的中间代码转化为针对各自平台的机器代码。</p>

<p><img src="/img/Simple_7/05.png" alt="img" /></p>

<h4 id="clang">Clang</h4>

<p>Clang 是一个C、C++、Objective-C和Objective-C++编程语言的编译器前端。它采用了LLVM作为其后端。</p>

<p>Clang是2005年由苹果电脑发起，是LLVM编译器工具集的前端（front-end），目的是输出代码对应的抽象语法树（Abstract Syntax Tree, AST），并将代码编译成LLVM Bitcode。接着在后端（back-end）使用LLVM编译成平台相关的机器语言 。Clang支持C、C++、Objective C。</p>

<p>Clang本身性能优异，其生成的AST所耗用掉的内存仅仅是GCC的20%左右，测试证明Clang编译Objective-C代码时速度为GCC的3倍，还能针对用户发生的编译错误准确地给出建议。</p>

<h3 id="三ios中的编译">三、iOS中的编译</h3>

<p>Objective C采用Clang作为前端，而Swift则采用swift()作为前端，二者LLVM(Low level vritual machine)作为编译器后端。编译过程如下图</p>

<p><img src="/img/Simple_7/06.png" alt="img" /></p>

<p>来看看一个文件的编译过程，新建Test.m</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
    <span class="err">@autoreleasepool</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span><span class="s">@"Hello Leo"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在终端输入：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang -ccc-print-phases -framework Foundation test.m -o test
</code></pre></div></div>

<p>会看到下列的：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: input, <span class="s2">"Foundation"</span>, object 
1: input, <span class="s2">"test.m"</span>, objective-c
2: preprocessor, <span class="o">{</span>1<span class="o">}</span>, objective-c-cpp-output//预处理
3: compiler, <span class="o">{</span>2<span class="o">}</span>, ir //编译生成IR<span class="o">(</span>中间代码<span class="o">)</span>
4: backend, <span class="o">{</span>3<span class="o">}</span>, assembler//汇编器生成汇编代码
5: assembler, <span class="o">{</span>4<span class="o">}</span>, object//生成机器码
6: linker, <span class="o">{</span>0, 5<span class="o">}</span>, image//链接
7: bind-arch, <span class="s2">"x86_64"</span>, <span class="o">{</span>6<span class="o">}</span>, image//生成Image，也就是最后的可执行文件
</code></pre></div></div>

<h4 id="编译器前端">编译器前端</h4>

<p>编译器前端的任务是进行：语法分析，语义分析，生成中间代码(intermediate representation )。在这个过程中，会进行类型检查，如果发现错误或者警告会标注出来在哪一行。</p>

<p><img src="/img/Simple_7/07.png" alt="img" /></p>

<h4 id="编译器优化">编译器优化</h4>

<p>LVVM优化器会进行BitCode的生成，链接期优化等等</p>

<p><img src="/img/Simple_7/08.png" alt="img" /></p>

<h4 id="编译器后端">编译器后端</h4>

<p>LLVM机器码生成器会针对不同的架构，比如arm64等生成不同的机器码</p>

<p><img src="/img/Simple_7/09.png" alt="img" /></p>

<h3 id="四xcode执行build的流程">四、Xcode执行Build的流程</h3>

<ul>
  <li>
    <p>编译信息写入辅助文件，创建编译后的文件架构(name.app)</p>
  </li>
  <li>
    <p>写入辅助文件：将项目的文件结构对应表、将要执行的脚本、项目依赖库的文件结构对应表写成文件，方便后面使用</p>
  </li>
  <li>
    <p>运行预设脚本：Cocoapods 会预设一些脚本，当然你也可以自己预设一些脚本来运行。这些脚本都在 Build Phases 中可以看到；</p>
  </li>
  <li>
    <p>编译文件：针对每一个文件进行编译，生成可执行文件 Mach-O，这过程 LLVM 的完整流程，前端、优化器、后端；使用<code class="highlighter-rouge">CompileC</code>和<code class="highlighter-rouge">clang</code>命令。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CompileC ClassName.o ClassName.m normal x86_64 objective-c com.apple.compilers.llvm.clang.1_0.compiler
export LANG=en_US.US-ASCII
export PATH="..."
clang -x objective-c -arch x86_64 -fmessage-length=0 -fobjc-arc... -Wno-missing-field-initializers ... -DDEBUG=1 ... -isysroot iPhoneSimulator10.1.sdk -fasm-blocks ... -I 上文提到的文件 -F 所需要的Framework  -iquote 所需要的Framework  ... -c ClassName.c -o ClassName.o
</code></pre></div>    </div>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang是实际的编译命令
-x      objective-c 指定了编译的语言
-arch   x86_64制定了编译的架构，类似还有arm7等
-fobjc-arc 一些列-f开头的，指定了采用arc等信息。这个也就是为什么你可以对单独的一个.m文件采用非ARC编程。
-Wno-missing-field-initializers 一系列以-W开头的，指的是编译的警告选项，通过这些你可以定制化编译选项
-DDEBUG=1 一些列-D开头的，指的是预编译宏，通过这些宏可以实现条件编译
-iPhoneSimulator10.1.sdk 制定了编译采用的iOS SDK版本
-I 把编译信息写入指定的辅助文件
-F 链接所需要的Framework
-c ClassName.c 编译文件
-o ClassName.o 编译产物
</code></pre></div>    </div>
  </li>
  <li>
    <p>链接库，例如<code class="highlighter-rouge">Foundation.framework</code>,<code class="highlighter-rouge">AFNetworking.framework</code>…</p>
  </li>
  <li>
    <p>拷贝资源文件：将项目中的资源文件拷贝到目标包；</p>
  </li>
  <li>
    <p>编译 storyboard 文件：storyboard 文件也是会被编译的；</p>
  </li>
  <li>
    <p>链接 storyboard 文件：将编译后的 storyboard 文件链接成一个文件；</p>
  </li>
  <li>
    <p>编译 Asset 文件：我们的图片如果使用 Assets.xcassets 来管理图片，那么这些图片将会被编译成机器码，除了 icon 和 launchImage；</p>
  </li>
  <li>
    <p>运行 Cocoapods 脚本：将在编译项目之前已经编译好的依赖库和相关资源拷贝到包中。</p>
  </li>
  <li>
    <p>创建.app文件和对其签名</p>
  </li>
</ul>

<h4 id="dsym-文件">dSYM 文件</h4>

<p>我们在每次编译过后，都会生成一个dsym文件。dsym文件中，存储了16进制的函数地址映射。</p>

<p>在App实际执行的二进制文件中，是通过地址来调用方法的。在App crash的时候，第三方工具（Fabric,友盟等）会帮我们抓到崩溃的调用栈，调用栈里会包含crash地址的调用信息。然后，通过dSYM文件，我们就可以由地址映射到具体的函数位置。</p>

<h3 id="五提高项目build速度">五、提高项目Build速度</h3>

<h4 id="查看编译时间">查看编译时间</h4>

<p>我们需要一个途径，能够看到编译的时间，这样才能有个对比，知道我们的优化究竟有没有效果。 
对于XCode 8，关闭XCode，终端输入以下指令</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ defaults write com.apple.dt.Xcode ShowBuildOperationDuration YES
</code></pre></div></div>

<h4 id="代码优化-forward-declaration">代码优化-<strong>forward declaration</strong></h4>

<p><code class="highlighter-rouge">@class CLASSNAME</code>，而不是<code class="highlighter-rouge">#import CLASSNAME.h</code>。这样，编译器能大大提高#import的替换速度。</p>

<h4 id="对常用工具类打包">对常用工具类打包</h4>

<p>打包成Framework或者静态库，这样编译的时候这部分代码就不需要重新编译了。</p>

<h4 id="常用头文件放到预编译文件里">常用头文件放到预编译文件里</h4>

<p>XCode的pch文件是预编译文件，这里的内容在执行XCode build之前就已经被预编译，并且引入到每一个.m文件里了。</p>

<p>编译器选项优化</p>

<h4 id="debug模式下不生成dsym文件">Debug模式下，不生成dsym文件</h4>

<p>上文提到了，dysm文件里存储了调试信息，在Debug模式下，我们可以借助XCode和LLDB进行调试。所以，不需要生成额外的dsym文件来降低编译速度。</p>

<h4 id="debug开启build-active-architecture-only">Debug开启<code class="highlighter-rouge">Build Active Architecture Only</code></h4>

<p>在XCode -&gt; Build Settings -&gt; Build Active Architecture Only 改为YES。这样做，可以只编译当前的版本，比如arm7/arm64等等，记得只开启Debug模式。这个选项在高版本的XCode中自动开启了。</p>

<h4 id="debug模式下关闭编译器优化">Debug模式下，关闭编译器优化</h4>

<p><img src="/img/Simple_7/10.png" alt="img" /></p>



                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/%E5%9F%BA%E7%A1%80/2018/03/23/OpenGL_4/" data-toggle="tooltip" data-placement="top" title="OpenGL ES编程指南（四）">&larr; 上一篇</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/ios/2018/03/31/app-2/" data-toggle="tooltip" data-placement="top" title="APP生成与运行(二)">下一篇 &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/helloted">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:helloted@live.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Helloted 2018</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

<script src="/js/prism.js "></script>


    


</body>

</html>
