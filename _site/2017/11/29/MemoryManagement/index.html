<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Write your site description here. It will be used as your sites meta description as well!">

    <title>内存管理 - Helloted Blog</title>

    <link rel="canonical" href="http://www.helloted.com/2017/11/29/MemoryManagement/">

    <link rel="shortcut icon" href="/img/favicon.ico">
   
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Helloted Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
				
                <li>
                    <a href="/about/">About</a>
                </li>
				
                
				
                <li>
                    <a href="/contact/">Contact</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/default.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>内存管理</h1>
                    
                    <h2 class="subheading">iOS内存管理指南</h2>
                    
                    <span class="meta">Posted by Ted on November 29, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>本文翻译自<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/MemoryMgmt.html#//apple_ref/doc/uid/10000011i">Advanced Memory Management Programming Guide</a></p>

<h3 id="一关于内存管理">一、关于内存管理</h3>

<blockquote>
  <p>Although memory management is typically considered at the level of an individual object, your goal is actually to manage <a href="">object graphs</a>. You want to make sure that you have no more objects in memory than you actually need.</p>
</blockquote>

<p><img src="/img/Simple_2/02.png" alt="img" /></p>

<p>内存管理通常被认为针对单个对象进行，目标实际去管理“对象图”，你需要确保除了你真的需要的对象，没有更多的对象再内存里。</p>

<h4 id="1objective-c有三种内存管理方式">1、Objective-C有三种内存管理方式：</h4>

<p>1.1、MRR(manual retain-release):通过跟踪你所拥有的对象来显式地管理内存，采用了”引用计数（ reference counting）”的模型。该模型由基础类NSObject和运行时Runtime共同提供</p>

<p>1.2、ARC(Automatic Reference Counting):系统采用MRR相同的引用计数系统，不同的时，在编译的时候插入了内存管理的方法。</p>

<p>1.3、GC(Garbage Collection)：Mac下才能使用，iOS不支持</p>

<h4 id="2内存管理存在两种错误">2、内存管理存在两种错误</h4>

<p>2.1、释放(free)或者覆盖(over-write)正在使用中的数据。</p>

<p>​	这会造成内存异常，导致应用程序崩溃，导致数据损坏。</p>

<p>2.2、不再使用的内存没有被释放，导致内存泄漏。</p>

<p>​	内存泄露，就是有内存分配但是不释放它，哪怕这块内存已经不用了。泄露，导致你的应 用程序占用越来越多的内存，并导致整体性能的下降，或者在 iOS 平台上导致应用终止。</p>

<h3 id="二内存管理策略">二、内存管理策略</h3>

<p>NSObject定义了一个dealloc方法，当一个对象被清除时，这个方法会被自动调用</p>

<h4 id="1内存管理基本原则">1、内存管理基本原则</h4>

<blockquote>
  <p>The memory management model is based on object ownership. Any object may have one or more owners. As long as an object has at least one owner, it continues to exist. If an object has no owners, the runtime system destroys it automatically.</p>
</blockquote>

<p>内存管理模型是建立在一个对象的”所有权”上，当一个对象有至少一个”所有者”时，它就会继续存在。否则，运行时系统就会将其自动清除</p>

<blockquote>
  <ul>
    <li>
      <p><strong>You own any object you create</strong></p>

      <p>You create an object using a method whose name begins with “alloc”, “new”, “copy”, or “mutableCopy” (for example, <code class="highlighter-rouge">alloc</code>, <code class="highlighter-rouge">newObject</code>, or <code class="highlighter-rouge">mutableCopy</code>).</p>
    </li>
    <li>
      <p><strong>You can take ownership of an object using retain</strong></p>

      <p>A received object is normally guaranteed to remain valid within the method it was received in, and that method may also safely return the object to its invoker. You use <code class="highlighter-rouge">retain</code> in two situations: (1) In the implementation of an accessor method or an <code class="highlighter-rouge">init</code> method, to take ownership of an object you want to store as a property value; and (2) To prevent an object from being invalidated as a side-effect of some other operation (as explained in <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmPractical.html#//apple_ref/doc/uid/20000043-1000922">Avoid Causing Deallocation of Objects You’re Using</a>).</p>
    </li>
    <li>
      <p><strong>When you no longer need it, you must relinquish ownership of an object you own</strong></p>

      <p>You relinquish ownership of an object by sending it a <code class="highlighter-rouge">release</code> message or an <code class="highlighter-rouge">autorelease</code> message. In Cocoa terminology, relinquishing ownership of an object is therefore typically referred to as “releasing” an object.</p>
    </li>
    <li>
      <p><strong>You must not relinquish ownership of an object you do not own</strong></p>

      <p>This is just corollary of the previous policy rules, stated explicitly.</p>
    </li>
  </ul>
</blockquote>

<ul>
  <li>
    <p>你拥有你所创建的对象</p>

    <p>你如果用下面字母作为开头的方法来创建对象，那么你将拥有这个对象:alloc、new、copy、mutableCopy。比如，alloc、newObject、或者 mutableCopy 等方法。</p>
  </li>
  <li>
    <p>你可以用 retain 来实现对一个对象的所有</p>

    <p>如果你在一个方法体中，得到了一个对象，那么这个对象在本方法内部是一直都有效的。而且你还可以在本方法中将这个对象作为返回值返回给方法的调用者。在下面两种状况下，你需要用retain:(1)在访问方法(getter、setter)或者 init 方法中，你希望将得到的返回对象作为成员变量(property)来存储。 (2)在执行某些操作时，你担心在过程中对象变得无效。(在 避免你正在使用的对象被 dealloc 中详细解释。)</p>
  </li>
  <li>
    <p>你不再需要一个对象时，你必须放弃对对象的持有</p>

    <p>通过向对象发送 release 消息或者 autorelease 消息来放弃所有权。用 Cocoa 的术语说，所谓放弃所有权，就是 release 一个对象。</p>
  </li>
  <li>
    <p>对于你正在使用的对象，不要 release 它</p>
  </li>
</ul>

<h4 id="2引用计数">2、引用计数</h4>

<p>每个对象都有一个引用计数</p>

<ul>
  <li>当新建一个对象时，它的 retain count 为 1;</li>
  <li>发送 retain 消息给一个对象时，它的 retain count 加 1;</li>
  <li>发送 release 消息给一个对象时，它的 retain count 减 1;</li>
  <li>发送 autorelease 消息，它的 retain count 将在未来某个时候减 1;</li>
  <li>如果 retain count 是 0，就会被 dealloc。</li>
</ul>

<h4 id="3弱引用">3、弱引用</h4>

<p>Retain 一个对象，实际是对一个对象的强引用(strong reference)。一个对象在所有的强引用 都解除之前，是不能被 dealloc 的，这导致一个被称为“循环引用”的问题:两个对象相互强引用 (可能是直接引用，也可能是通过其他对象间接地引用。)</p>

<p>解决的方法就是弱引用：父对象建立对子对象的强引用，而子对象只对父对象建立弱引用。</p>

<p>在 Cocoa 中，弱引用的例子包括(但不限于)Table 表格的数据源、Outline 视图项目(Outline view item)、通知观察者(Notification Observer)和其他的 target 以及 delegate。</p>

<p>对你弱引用的对象发送消息时，需要注意:当你发送消息给一个被 dealloc 的弱引用对象时，你的程序会崩溃。因此，你必须细致地判断对象是否有效。多数情况下，被弱引用的对象是知道其 他对象对它的弱引用的(比如环形持有的情形)，所以需要通知其他对象它自己的 dealloc。举例， 当你向 Notification Center 注册一个对象时，Notification Center 对这个对象是弱引用的，并且在有 消息需要通知到这个对象时，就发送消息给这个对象。当这个对象 dealloc 的时候，你必须向 Notification Center 取消这个对象的注册。这样，这个 Notification Center 就不会再发送消息给这个 不存在的对象了。同样，当一个 delegate 对象被 dealloc 的时候，必须向其他对象发送一个 setDelegate:消息，并传递 nil 参数，从而将代理的关系撤销。这些消息通常在对象的 dealloc 方法 中发出。</p>

<h3 id="三autorelease">三、autorelease</h3>

<p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmAutoreleasePools.html#//apple_ref/doc/uid/20000047-CJBFBEDI">Autorelease Pool</a></p>

<h4 id="1autorelease">1、autorelease</h4>

<p>当你需要延时 release 方式时，就需要 autorelease 了，特别是当你从方法中返回一个对象的时候。比如，你可以这样来实现 fullName: 方法:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>   -(NSString *)fullName{
      NSString *string = [[[NSString alloc] initWithFormat:@”%@ %@”,self.firstName, self.lastName] autorelease];
       return string;
    }
</code></pre>
</div>

<p>上例中，你使用 alloc 方法创建了 string，所以你有该对象的所有权，因此你有义务在失去对它的引用前放弃该所有权。但如果你用 release，那么这种所有权的放弃是“即刻的”，立即生效。可是我们却要将这个对象 return，这将造成 return 时对象已经实际失效，方法实际上返回了一个无效的对象。我们采用 autorelease 来声明(译者:注意这里仅仅是一种意愿的表达，而非实际放弃的动作。)我们对所有权的放弃，但是同时允许 fullName: 方法的调用者来使用该对象。</p>

<p>你还可以按下面做法来实现这个方法:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>   -(NSString *) fullName{
       NSString *string = [NSString stringWithFormat:@”%@ %@”, self.firstName,   self.lastName] ;
       return string;
  }
</code></pre>
</div>

<p>根据我们说的基本规则，你对 stringWithFormat: 所返回的 string 没有所有权(译者:请注意到这里并没有使用 alloc，方法名也不是以 init 开始)。 因此你可以直接返回 string 给方法的调用者。</p>

<h4 id="2autorelease-pool">2、Autorelease Pool</h4>

<p>Autorelease pool是得到了 autorelease 消息的对象的容器。 在 autorelease pool被 dealloc 的时候，它自己会给容纳的所有对象发送 release 消息。一个对象可以被多次放到同一个 autorelease pool，每一次放入(发送 autorelease消息)都会造成将来收到一次release。</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/11/27/leakmonitor/" data-toggle="tooltip" data-placement="top" title="iOS之Runtime运用:埋点统计">&larr; 上一篇</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/helloted">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:helloted@live.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Helloted 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    


</body>

</html>
